10 ' --- Slot 0
20 ' color 1
30 DATA 00,7F,7F,00,6D,6D,6D,6C,6D,6B,67,6E,6D,00,7F,7F
40 DATA 00,FF,FF,00,DB,BB,73,EB,DB,9B,5B,DB,DB,00,FF,FF
50 ' 
60 ' --- Slot 1
70 ' color 1
80 DATA 00,07,1F,33,73,7F,FF,FF,FF,FF,FF,7F,7F,3F,1F,07
90 DATA 00,C0,F0,98,9C,FC,FE,FE,FE,FE,FE,FC,FC,F8,F0,C0
100 ' 
110 ' --- Slot 2
120 ' color 1
130 DATA 00,07,1F,3F,7F,7F,FF,FF,FF,FF,FF,7F,7F,3F,1F,07
140 DATA 00,C0,F0,F8,FC,E4,E6,FE,FE,FE,E6,E4,FC,F8,F0,C0
150 ' 
160 ' --- Slot 3
170 ' color 1
180 DATA 00,07,1F,3F,7F,7F,FF,FF,FF,FF,FF,7F,73,33,1F,07
190 DATA 00,C0,F0,F8,FC,FC,FE,FE,FE,FE,FE,FC,9C,98,F0,C0
200 ' 
210 ' --- Slot 4
220 ' color 1
230 DATA 00,07,1F,3F,7F,4F,CF,FF,FF,FF,CF,4F,7F,3F,1F,07
240 DATA 00,C0,F0,F8,FC,FC,FE,FE,FE,FE,FE,FC,FC,F8,F0,C0

241 ' --- Slot 0 Down
242 DATA 00,00,07,0F,08,3F,D0,DF,8F,CF,67,97,93,50,02,01
243 DATA 00,00,C0,E0,20,F8,16,F6,E2,E6,CC,D2,92,14,80,00
244 ' --- Slot 1 Right
245 DATA 00,00,07,0F,0F,3F,DF,DF,8F,CF,67,97,93,50,02,01
246 DATA 00,00,C0,E0,20,F0,10,F0,E0,E0,C0,C0,80,00,80,00
247 ' --- Slot 2 Up
248 DATA 00,00,07,0F,0F,3F,DF,DF,8F,CF,67,97,93,50,02,01
249 DATA 00,00,C0,E0,E0,F8,F6,F6,E2,E6,CC,D2,92,14,80,00
250 ' --- Slot 3 Left
251 DATA 00,00,07,0F,09,1F,11,1F,0F,0F,07,07,03,00,02,01
252 DATA 00,00,C0,E0,E0,F8,F6,F6,E2,E6,CC,D2,92,14,80,00

259 DATA *

260 COLOR 15,1,1:SCREEN 2,2,0
261 BLOAD "push_gam.sc2",S

264 DEFINT A-Z
265 CALL TURBO ON
266 DIM TL(767)
268 GOSUB 10000

271 'FIND ENEMY SPAWN POINT (TILES 7-10)
272 FOR I=0 TO 767
273   T=VPEEK(&H1800+I)
274   IF T<130 THEN TL(I)=T ELSE TL(I)=T-128
275   IF T>=7 AND T<=10 THEN EY=(I/32)*8:EX=((I MOD 32)-1)*8:ED=T-6:EM=8
276 NEXT I
280 X=16:Y=16:GS=1:MD=1

300 TIME=0
301 ON GS GOSUB 400,500,600

310 ' ENEMY MOVES
310 GOSUB 700

350 PUT SPRITE 0,(X,Y),8,MD
390 IF TIME<1 THEN 390
399 GOTO 300

400 'IDLE
400 PT=&H1800+X\8+(Y\8)*32:PP=0
401 ON STICK(0) GOTO 410,499,430,499,450,499,470,499
402 GOTO 499

410 MD=1
411 T1=VPEEK(PT-32):T2=VPEEK(PT-31)
412 IF T1=162 THEN GOTO 420
419 GOTO 490
420 IF VPEEK(PT-96)<64 AND VPEEK(PT-95)<64 THEN GS=3:MS=8:PUT SPRITE 1,(X,Y-17),9,0:PP=PT-64:PF=PP-32
429 GOTO 490

430 MD=2:
431 T1=VPEEK(PT+2):T2=VPEEK(PT+34)
432 IF T1=130 THEN GOTO 440
439 GOTO 490
440 IF VPEEK(PT+4)<64 AND VPEEK(PT+36)<64 THEN GS=3:MS=8:PUT SPRITE 1,(X+16,Y-1),9,0:PP=PT+2:PF=PP+1
449 GOTO 490

450 MD=3
451 T1=VPEEK(PT+64):T2=VPEEK(PT+65)
452 IF T1=130 THEN GOTO 460
459 GOTO 490
460 IF VPEEK(PT+128)<64 AND VPEEK(PT+129)<64 THEN GS=3:MS=8:PUT SPRITE 1,(X,Y+15),9,0:PP=PT+64:PF=PP+32
469 GOTO 490

470 MD=4
471 T1=VPEEK(PT-1):T2=VPEEK(PT+31)
472 IF T1=131 THEN GOTO 480
479 GOTO 490
480 IF VPEEK(PT-3)<64 AND VPEEK(PT+29)<64 THEN GS=3:MS=8:PUT SPRITE 1,(X-16,Y-1),9,0:PP=PT-2:PF=PP-1
489 GOTO 490

490 IF T1<64 AND T2<64 THEN GS=2:MS=8
491 IF PP>0 THEN VPOKE PP,TL(PP-&H1800):VPOKE PP+1,TL(PP+1-&H1800):VPOKE PP+32,TL(PP+32-&H1800):VPOKE PP+33,TL(PP+33-&H1800)
499 RETURN

500 'MOVING
500 ON MD GOTO 510,520,530,540
510 Y=Y-1:GOTO 550
520 X=X+1:GOTO 550
530 Y=Y+1:GOTO 550
540 X=X-1:GOTO 550
550 MS=MS-1:IF MS=0 THEN GS=1
599 RETURN

600 'PUSHING
600 ON MD GOTO 610,620,630,640
610 Y=Y-1
611 PUT SPRITE 1,(X,Y-17),9,0
612 GOTO 650
620 X=X+1
621 PUT SPRITE 1,(X+16,Y-1),9,0
622 GOTO 650
630 Y=Y+1
631 PUT SPRITE 1,(X,Y+15),9,0
632 GOTO 650
640 X=X-1
641 PUT SPRITE 1,(X-16,Y-1),9,0
642 GOTO 650

650 MS=MS-1' TODO USE MOD instead?
651 IF MS=0 THEN GS=1:VPOKE PF,130:VPOKE PF+1,131:VPOKE PF+32,162:VPOKE PF+33,163:PUT SPRITE 1,(0,0),0,0

699 RETURN


700 ' ENEMY MOVES
701 ON ED GOTO 710,720, 730, 740

710 'DOWN (TODO ALIGN TILES WITH THE JOYSTICK DIRECTIONS FOR CLARITY)
711 EY=EY+1: IF (EY MOD 8) = 0 GOTO 750 ELSE GOTO 790
720 EX=EX+1: IF (EX MOD 8) = 0 GOTO 750 ELSE GOTO 790
730 EY=EY-1: IF (EY MOD 8) = 0 GOTO 750 ELSE GOTO 790
740 EX=EX-1: IF (EX MOD 8) = 0 GOTO 750 ELSE GOTO 790

750 ET=&H1800+EX\8+(EY\8)*32 'TODO: Bounce back also if there is an obstacle (no need for bouncing tile)
751 TE=VPEEK(ET)
752 IF TE=4 THEN IF ED=4 THEN ED=1:GOTO 790
753 IF TE=5 THEN IF ED=2 THEN ED=1:GOTO 790
754 IF TE=5 THEN IF ED=3 THEN ED=4:GOTO 790
755 IF TE=6 THEN ED=((ED+2) MOD 4):GOTO 790

760 ON ED GOTO 761, 762, 763, 764
761 T3=ET-32:T4=T3+1: GOTO 765
762 T3=ET+2:T4=T3+32: GOTO 765
763 T3=ET+64:T4=T3+1: GOTO 765
764 T3=ET-1:T4=T3+32: GOTO 765

765 E3=VPEEK(T3): E4=VPEEK(T4)
766 IF E3>64 OR E4>64 THEN ED=((ED+2) MOD 4): IF ED=0 THEN ED=4

790 IF ED=0 THEN ED=4
791 PUT SPRITE 2,(EX,EY-1),4,ED+4
799 RETURN

10000 REM -- LOAD SPRITES
10010 S=&H3800
10020 READ R$: IF R$="*" THEN RETURN ELSE VPOKE S,VAL("&H"+R$):S=S+1:GOTO 10020
